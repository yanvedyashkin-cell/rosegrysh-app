<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экран ведущего - Активность участников</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Стили из предыдущего ответа остаются без изменений */
        /* Полный CSS код из предыдущего ответа */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML структура из предыдущего ответа -->
    </div>
    
    <!-- Экран победителя -->
    <div class="winner-screen" id="winner-screen">
        <!-- HTML структура из предыдущего ответа -->
    </div>

    <script>
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCLmWH2TcIOCwCe6Ydfdqfk5T8Ykl0bTaU",
  authDomain: "rosegrysh-app.firebaseapp.com",
  databaseURL: "https://rosegrysh-app-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "rosegrysh-app",
  storageBucket: "rosegrysh-app.firebasestorage.app",
  messagingSenderId: "214655838902",
  appId: "1:214655838902:web:093b159412cbce06009417"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        // Элементы DOM
        const startDrawBtn = document.getElementById('start-draw-btn');
        const customTimeBtn = document.getElementById('custom-time-btn');
        const pickWinnerBtn = document.getElementById('pick-winner-btn');
        const resetBtn = document.getElementById('reset-btn');
        const restartBtn = document.getElementById('restart-btn');
        const timer = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const participantsGrid = document.getElementById('participants-grid');
        const totalParticipants = document.getElementById('total-participants');
        const activeNow = document.getElementById('active-now');
        const totalEmojis = document.getElementById('total-emojis');
        const avgActivity = document.getElementById('avg-activity');
        const winnerScreen = document.getElementById('winner-screen');
        const winnerName = document.getElementById('winner-name');
        const winnerCard = document.getElementById('winner-card');

        // Переменные состояния
        let participants = [];
        let drawTimer = null;
        let drawTimeLeft = 0;
        let drawDuration = 30;
        let isDrawActive = false;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Удаляем демо-карточку
            setTimeout(() => {
                const demoCard = document.querySelector('.demo-card');
                if (demoCard) demoCard.remove();
            }, 1000);
        });

        // Обработчики кнопок
        startDrawBtn.addEventListener('click', function() {
            startDraw(30);
        });

        customTimeBtn.addEventListener('click', function() {
            const customTime = prompt('Введите время розыгрыша в секундах:', '60');
            if (customTime && !isNaN(customTime) && customTime > 0) {
                startDraw(parseInt(customTime));
            }
        });

        pickWinnerBtn.addEventListener('click', function() {
            if (participants.length === 0) {
                alert('Нет участников для розыгрыша!');
                return;
            }
            pickWinner();
        });

        resetBtn.addEventListener('click', function() {
            resetDraw();
        });

        restartBtn.addEventListener('click', function() {
            resetDraw();
        });

        // Инициализация приложения с Firebase
        function initializeApp() {
            // Слушаем участников в Firebase
            database.ref('participants').on('value', (snapshot) => {
                participants = [];
                let totalEmojiCount = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const participant = childSnapshot.val();
                    participant.id = childSnapshot.key;
                    participants.push(participant);
                    totalEmojiCount += participant.emojiCount || 0;
                });
                
                updateParticipantsGrid();
                updateStats(totalEmojiCount);
            });

            // Обновляем статистику каждую секунду
            setInterval(updateStats, 1000);
        }

        // Запуск розыгрыша
        function startDraw(duration) {
            if (isDrawActive) return;
            
            drawDuration = duration;
            drawTimeLeft = duration;
            isDrawActive = true;
            
            updateTimer();
            updateProgressBar();
            
            // Блокируем кнопки
            startDrawBtn.disabled = true;
            customTimeBtn.disabled = true;
            pickWinnerBtn.disabled = true;
            
            // Оповещаем участников о начале розыгрыша
            database.ref('drawState').set({
                started: true,
                finished: false,
                progress: 0,
                winner: null
            });
            
            drawTimer = setInterval(function() {
                drawTimeLeft--;
                updateTimer();
                updateProgressBar();
                
                // Обновляем прогресс в Firebase
                const progressPercent = ((drawDuration - drawTimeLeft) / drawDuration) * 100;
                database.ref('drawState').update({
                    progress: progressPercent
                });
                
                if (drawTimeLeft <= 0) {
                    clearInterval(drawTimer);
                    finishDraw();
                }
            }, 1000);
        }

        // Обновление таймера
        function updateTimer() {
            const minutes = Math.floor(drawTimeLeft / 60);
            const seconds = drawTimeLeft % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (drawTimeLeft <= 10) {
                timer.style.color = '#ff4444';
            } else {
                timer.style.color = '#FFD700';
            }
        }

        // Обновление прогресс-бара
        function updateProgressBar() {
            const progressPercent = ((drawDuration - drawTimeLeft) / drawDuration) * 100;
            progressBar.style.width = progressPercent + '%';
        }

        // Завершение розыгрыша
        function finishDraw() {
            isDrawActive = false;
            
            // Оповещаем участников о завершении
            database.ref('drawState').update({
                finished: true
            });
            
            // Автоматически выбираем победителя
            setTimeout(() => {
                pickWinner();
            }, 2000);
        }

        // Выбор победителя
        function pickWinner() {
            if (participants.length === 0) {
                alert('Нет участников для розыгрыша!');
                return;
            }
            
            // Случайный выбор из всех участников
            const randomIndex = Math.floor(Math.random() * participants.length);
            const winner = participants[randomIndex];
            
            // Оповещаем всех о победителе
            database.ref('drawState').update({
                winner: winner.id
            });
            
            showWinner(winner);
            createConfetti(300);
        }

        // Показ победителя
        function showWinner(winner) {
            winnerScreen.classList.add('active');
            winnerName.textContent = `${winner.firstName} ${winner.lastName}`;
            
            // Обновляем статистику победителя
            const winnerStats = winnerCard.querySelector('.winner-details');
            winnerStats.innerHTML = `
                <div class="winner-stat">
                    <div style="font-size: 1.2rem; color: #FFD700;">Лопнуто эмодзи</div>
                    <div style="font-size: 2rem; font-weight: bold;">${winner.emojiCount}</div>
                </div>
                <div class="winner-stat">
                    <div style="font-size: 1.2rem; color: #FFD700;">Уровень активности</div>
                    <div style="font-size: 2rem; font-weight: bold;">${Math.min(winner.emojiCount / 0.7, 100).toFixed(0)}%</div>
                </div>
                <div class="winner-stat">
                    <div style="font-size: 1.2rem; color: #FFD700;">Время участия</div>
                    <div style="font-size: 2rem; font-weight: bold;">${Math.floor((new Date() - new Date(winner.joinedAt)) / 60000)} мин</div>
                </div>
                <div class="winner-stat">
                    <div style="font-size: 1.2rem; color: #FFD700;">Место в рейтинге</div>
                    <div style="font-size: 2rem; font-weight: bold;">${getParticipantRank(winner.id)}</div>
                </div>
            `;
        }

        // Получение места в рейтинге
        function getParticipantRank(participantId) {
            const sorted = [...participants].sort((a, b) => b.emojiCount - a.emojiCount);
            return sorted.findIndex(p => p.id === participantId) + 1;
        }

        // Сброс розыгрыша
        function resetDraw() {
            if (drawTimer) {
                clearInterval(drawTimer);
            }
            
            isDrawActive = false;
            drawTimeLeft = 0;
            updateTimer();
            progressBar.style.width = '0%';
            
            // Разблокируем кнопки
            startDrawBtn.disabled = false;
            customTimeBtn.disabled = false;
            pickWinnerBtn.disabled = false;
            
            // Сбрасываем состояние розыгрыша в Firebase
            database.ref('drawState').set({
                started: false,
                finished: false,
                progress: 0,
                winner: null
            });
            
            // Скрываем экран победителя
            winnerScreen.classList.remove('active');
            
            timer.style.color = '#FFD700';
        }

        // Обновление сетки участников
        function updateParticipantsGrid() {
            participantsGrid.innerHTML = '';
            
            // Сортируем по активности (количеству эмодзи)
            const sortedParticipants = [...participants].sort((a, b) => b.emojiCount - a.emojiCount);
            
            sortedParticipants.forEach(participant => {
                createParticipantCard(participant);
            });
        }

        // Создание карточки участника
        function createParticipantCard(participant) {
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.setAttribute('data-participant-id', participant.id);
            
            const activityLevel = Math.min(participant.emojiCount / 0.7, 100);
            const lastActivity = new Date(participant.lastActivity);
            const now = new Date();
            const minutesAgo = Math.floor((now - lastActivity) / 60000);
            const isOnline = participant.isOnline && minutesAgo < 5; // Считаем онлайн если активен в последние 5 минут
            
            card.innerHTML = `
                <div class="participant-header">
                    <div class="participant-name">${participant.firstName} ${participant.lastName}</div>
                    <div class="participant-status ${isOnline ? 'status-online' : 'status-offline'}">
                        ${isOnline ? 'ОНЛАЙН' : 'ОФФЛАЙН'}
                    </div>
                </div>
                <div class="participant-stats">
                    <div class="stat-item">
                        <div class="stat-value">${participant.emojiCount}</div>
                        <div class="stat-label-small">Эмодзи</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${activityLevel.toFixed(0)}%</div>
                        <div class="stat-label-small">Активность</div>
                    </div>
                </div>
                <div class="activity-bar-container">
                    <div class="activity-label">
                        <span>Уровень активности</span>
                        <span>${activityLevel.toFixed(0)}%</span>
                    </div>
                    <div class="activity-bar">
                        <div class="activity-level" style="width: ${activityLevel}%"></div>
                    </div>
                </div>
                <div class="participant-footer">
                    <span>Зарегистрирован: ${new Date(participant.joinedAt).toLocaleTimeString()}</span>
                    <span>Активен: ${minutesAgo} мин назад</span>
                </div>
            `;
            
            participantsGrid.appendChild(card);
        }

        // Обновление статистики
        function updateStats() {
            totalParticipants.textContent = participants.length;
            
            const onlineCount = participants.filter(p => {
                const lastActivity = new Date(p.lastActivity);
                const now = new Date();
                return (now - lastActivity) < 5 * 60 * 1000; // Активны в последние 5 минут
            }).length;
            
            activeNow.textContent = onlineCount;
            
            const totalEmojiCount = participants.reduce((sum, p) => sum + (p.emojiCount || 0), 0);
            totalEmojis.textContent = totalEmojiCount;
            
            const averageActivity = participants.length > 0 ? 
                Math.round(totalEmojiCount / participants.length) : 0;
            avgActivity.textContent = averageActivity;
        }

        // Создание конфетти
        function createConfetti(count) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff69b4'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.width = Math.random() * 15 + 5 + 'px';
                confetti.style.height = Math.random() * 15 + 5 + 'px';
                document.body.appendChild(confetti);
                
                animateConfetti(confetti);
            }
        }

        // Анимация конфетти
        function animateConfetti(confetti) {
            const duration = Math.random() * 3 + 2;
            const rotation = Math.random() * 720 - 360;
            
            confetti.style.animation = `
                fall ${duration}s linear forwards,
                spin ${duration / 10}s linear infinite
            `;
            confetti.style.opacity = '1';
            
            setTimeout(() => {
                confetti.remove();
            }, duration * 1000);
            
            if (!document.querySelector('#confetti-styles')) {
                const style = document.createElement('style');
                style.id = 'confetti-styles';
                style.textContent = `
                    @keyframes fall {
                        0% { transform: translateY(-100px) rotate(0deg); }
                        100% { transform: translateY(100vh) rotate(${rotation}deg); }
                    }
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
    </script>
</body>
</html>